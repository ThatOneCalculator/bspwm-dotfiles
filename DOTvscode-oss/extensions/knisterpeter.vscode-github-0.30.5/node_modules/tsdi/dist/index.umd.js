!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("reflect-metadata")):"function"==typeof define&&define.amd?define(["exports","reflect-metadata"],e):e((t=t||self).tsdi={})}(this,function(t){function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}).apply(this,arguments)}function n(t,e){return(n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function o(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function r(t,e,i){return(r=o()?Reflect.construct:function(t,e,o){var r=[null];r.push.apply(r,e);var i=new(Function.bind.apply(t,r));return o&&n(i,o.prototype),i}).apply(null,arguments)}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}var a,c=(a=function(t){return-1!==(t||"").indexOf("tsdi")||"*"===t},"object"==typeof t&&"undefined"!=typeof module?a(process.env.DEBUG):"undefined"!=typeof window&&a(window.localStorage.getItem("DEBUG"))),s=function(t){var e=function(t){var e,n=[].slice.call(arguments,1);if(c)if(t instanceof Error)console.error(t);else{for(var o=[],r=0,i=0,a=t.indexOf("%",i);-1!==a;){switch(o.push(t.substring(i,a)),t.substr(a,2)){case"%o":o.push(n[r++]);break;case"%s":o.push(String(n[r++]))}a=t.indexOf("%",i=a+2)}i<t.length&&o.push(t.substring(i)),(e=console).log.apply(e,o)}};return e.enabled=c,e};function u(t){return Boolean(t.rtti)}function f(t,e){for(var n=-1,o=0,r=t.length;o<r;o++)e(t[o])&&(n=o);return n}function p(t){return"string"==typeof t?{name:t}:t}var l=[],d=[],y=[];function m(t){if(t.options.name&&f(d,function(e){return e.options.name===t.options.name})>-1)throw new Error("Duplicate name '"+t.options.name+"' for known Components.");d.push(t),l.forEach(function(e){return e(t)})}function h(t){(function(t){return-1!==f(y,function(e){return e===t})})(t)||(y.push(t),l.forEach(function(e){return e(t)}))}var g=s();function v(){var t=[].slice.call(arguments),e=function(t,e){void 0===e&&(e={}),g("@Component "+t.name);var n=p(e);return m({fn:t,options:n}),Reflect.defineMetadata("component:options",n,t),t};return 1===t.length&&"function"==typeof t[0]?e(t[0],{}):function(n){return e(n,t[0]||{})}}var I=v,C=s();function b(){var t=[].slice.call(arguments),e=function(t,e){C("@Destroy %s#%s",t.constructor.name,e),Reflect.defineMetadata("component:destroy",e,t)};return t.length>0?e(t[0],t[1]):function(t,n){e(t,n)}}var M=b,j=s();function w(){var t=[].slice.call(arguments),e=function(t){j("@External "+t.name),h(t);var e=function(){return t.__tsdi__.configureExternal([].slice.call(arguments),t)};return Object.defineProperty(e,"name",{value:t.name}),Object.defineProperty(e,"__tsdi__external__",{value:t}),e.displayName=t.name,Object.getOwnPropertyNames(t).filter(function(t){return"name"!==t&&"length"!==t&&"caller"!==t&&"callee"!==t&&"arguments"!==t&&!e[t]}).forEach(function(n){return e[n]=t[n]}),e.prototype=t.prototype,e};return t.length>0?e(t[0]):function(t){return e(t)}}var _=w,O=s();function R(){var t=[].slice.call(arguments),e=function(t,e,n){O.enabled&&O('@Factory %s#%s({name: "%s"})',t.constructor.name,e,t[e].name),m({target:t,property:e.toString(),options:n,rtti:Reflect.getMetadata("design:returntype",t,e)})};if(t.length>1)return e(t[0],t[1],{});var n=t[0]||{};return function(t,o){e(t,o,n)}}var E=R,x=s();function z(){var t=[].slice.call(arguments),e=function(t,e){x("@Initialize %s#%s",t.constructor.name,e),Reflect.defineMetadata("component:init",e,t);var n=Reflect.getMetadata("design:returntype",t,e)===Promise;Reflect.defineMetadata("component:init:async",n,t)};return t.length>0?e(t[0],t[1]):function(t,n){e(t,n)}}var P=z,k=s();function F(){var t=[].slice.call(arguments),e=function(t){var e=p(t||{});return void 0===e.lazy&&(e.lazy=!0),e},n=function(t,e,n){k("@Inject "+t.constructor.name+"#"+String(e));var o=Reflect.getMetadata("design:type",t,e),r=Reflect.getMetadata("component:injects",t);r||(r=[],Reflect.defineMetadata("component:injects",r,t)),r.push({target:t,property:e.toString(),options:n,type:o})},o=function(t,e,n,o){k("@Inject "+String(e));var r=Reflect.getMetadata("component:parameters",t);r||(r=[],Reflect.defineMetadata("component:parameters",r,t)),r.push({options:o,index:n,rtti:Reflect.getMetadata("design:paramtypes",t)[n]})};if(!(t.length>1))return function(r,i,a){var c=e(t[0]||{});return void 0===a?n(r,i,c):o(r,i,a,c)};var r=e({});void 0===t[2]?n(t[0],t[1],r):o(t[0],t[1],t[2],r)}var A=F;function S(){var t=[].slice.call(arguments),e=function(t,e){Reflect.defineMetadata("component:configured",!0,t,e);var n=t[e.toString()],o="__tsdi__"+e.toString()+"__",r=Reflect.getMetadata("design:returntype",t,e),i=Reflect.getMetadata("design:type",t,e);return{configurable:!0,enumerable:!0,writable:!0,value:function(){var a=this;if(!r)return this.__tsdi__.get(i);if(o in this)return this[o];var c=Reflect.getMetadata("design:paramtypes",t,e).map(function(t){return a.__tsdi__.get(t)}),s=n.call.apply(n,[this].concat(c));return Object.defineProperty(this,o,{configurable:!1,enumerable:!1,writable:!1,value:s}),s}}};return t.length>0?e(t[0],t[1]):function(t,n){return e(t,n)}}var D=s(),L=function(){function t(e,n){var o=this;this.autoMock=void 0,this.components=[],this.instances={},this.properties={},this.lifecycleListeners=[],this.scopes={},this.registerComponent({fn:t,options:{}}),this.instances[0]=this,e&&(this.registerComponent({fn:e.constructor,options:{}}),this.instances[1]=e,Object.defineProperty(e,"__tsdi__",{configurable:!1,enumerable:!1,writable:!1,value:this}),Object.getOwnPropertyNames(e.constructor.prototype).filter(function(t){return Reflect.getMetadata("component:configured",e.constructor.prototype,t)}).forEach(function(t){var n=Reflect.getMetadata("design:returntype",e,t);if(n)o.registerComponent({target:e,property:t,options:{},rtti:n});else{var r=Reflect.getMetadata("design:type",e,t);r.__tsdi__external__?r.__tsdi__external__.__tsdi__=o:o.registerComponent({fn:r,options:{}})}})),this.parent=n}var n=t.prototype;return n.addLifecycleListener=function(t){var e=this;return this.lifecycleListeners.push(t),Object.keys(this.instances).forEach(function(t){return e.notifyOnCreate(e.instances[parseInt(t,10)])}),Object.values(this.instances).map(function(t){return[t,e.getInitializerPromise(t)]}).forEach(function(t){var n=t[0],o=t[1];return null==o?void 0:o.then(function(){return e.notifyOnReady(n)})}),function(){var n=e.lifecycleListeners.findIndex(function(e){return e===t});e.lifecycleListeners.splice(n,1)}},n.notifyOnCreate=function(t){this.lifecycleListeners.forEach(function(e){return null==e.onCreate?void 0:e.onCreate(t)})},n.notifyOnReady=function(t){this.lifecycleListeners.forEach(function(e){return null==e.onReady?void 0:e.onReady(t)})},n.notifyOnDestroy=function(t){this.lifecycleListeners.forEach(function(e){return null==e.onDestroy?void 0:e.onDestroy(t)})},n.addProperty=function(t,e){this.properties[t]=e},n.close=function(){var t,e,n,o=this;Object.keys(this.instances).forEach(function(t){var e=parseInt(t,10),n=o.components[e];u(n)||o.destroyInstance(e,n)}),this.instances=[],this.listener&&(t=this.listener,n=f(e=l,function(e){return e===t}),l=n>-1?[].concat(e.slice(0,n),e.slice(n+1)):e,this.listener=void 0)},n.destroyInstance=function(t,e){var n=this.instances[t];if(n){this.notifyOnDestroy(n);var o=Reflect.getMetadata("component:destroy",u(e)?e.rtti:e.fn.prototype);o&&n[o]&&n[o].call(n),this.instances[t]=void 0}},n.enableComponentScanner=function(){var t,e=this;this.listener||(this.listener=function(t){"function"==typeof t?t.__tsdi__=e:e.registerComponent(t)},this.listener&&(l.push(t=this.listener),d.forEach(function(e){return t(e)}),y.forEach(function(e){return t(e)})))},n.enableAutomock=function(){console.warn("#enableAutomock is deprecated and should not be used. Instead use #override."),this.autoMock=[].slice.call(arguments)},n.registerComponent=function(t){var e=this;if(-1===this.components.indexOf(t)&&(t.options.name&&f(this.components,function(e){return e.options.name===t.options.name})>-1&&console.warn("Component with name '"+t.options.name+"' already registered."),this.markAsyncInitializer(t),D("registerComponent %o",u(t)?t.rtti.name:t.fn.name),this.components.push(t),t.options.eager)){var n=this.components.length-1;setTimeout(function(){e.getOrCreate(t,n)},0)}},n.markAsyncInitializer=function(t){if(u(t)){var e=Reflect.getMetadata("component:init:async",t.target.constructor.prototype);Reflect.defineMetadata("component:init:async",e,t.rtti.prototype)}else{var n=Reflect.getMetadata("component:init:async",t.fn.prototype),o=(Reflect.getMetadata("component:injects",t.fn.prototype)||[]).some(function(t){return t.type&&Reflect.getMetadata("component:init:async",t.type.prototype)});!n&&o&&Reflect.defineMetadata("component:init:async",!0,t.fn.prototype)}},n.register=function(t,n){var o=Reflect.getMetadata("component:options",t)||{};this.registerComponent({fn:t,options:e({},o,{name:n||o.name})})},n.getComponentMetadataIndex=function(t,e){for(var n=0,o=this.components.length;n<o;n++)if(e){if(e===this.components[n].options.name)return n}else if(this.isComponentMetadataIndexFromComponentOrFactory(t,this.components[n]))return n;return-1},n.isComponentMetadataIndexFromComponentOrFactory=function(t,e){return void 0!==t&&(u(e)?e.rtti:e.fn)===t},n.throwComponentNotFoundError=function(t,e,n){throw t&&!e&&(e=t.name),e||(e="unknown"),new Error("Component '"+e+"' not found"+(n?": "+n:""))},n.getConstructorParameters=function(t){var e=this,n=Reflect.getMetadata("component:parameters",t.fn);return n?n.sort(function(t,e){return t.index-e.index}).map(function(t){return{index:e.getComponentMetadataIndex(t.rtti,t.options.name)}}).map(function(t){var n=t.index;return e.getOrCreate(e.components[n],n)}):[]},n.isSingleton=function(t){return void 0===t.options.singleton||t.options.singleton},n.getOrCreateFactory=function(t){return this.get(t.target.constructor)},n.hasAsyncFactoryInitializer=function(t){var e=this.getOrCreateFactory(t),n=this.getInitializerPromise(e);return Boolean(n)},n.getOrCreate=function(t,e){D("> getOrCreate %o",t);var n=this.instances[e];return n&&this.isSingleton(t)||(u(t)?(D("create %o from factory with %o",t.rtti.name,t.options),n=this.getOrCreateFactory(t)[t.property](),this.instances[e]=n):n=this.createComponent(t,e),this.notifyOnCreate(n)),D("< getOrCreate %o -> %o",t,n),n},n.addInitializerPromise=function(t,e){e&&Reflect.defineMetadata("tsdi:initialize:promise",e,t)},n.getInitializerPromise=function(t){return Reflect.getMetadata("tsdi:initialize:promise",t)},n.createComponent=function(t,e){this.hasEnteredScope(t)||this.throwComponentNotFoundError(t.fn,void 0,"required scope '"+t.options.scope+"' is not enabled"),D("create %o with %o",t.fn.name,t.options);var n=r(t.fn,this.getConstructorParameters(t));this.instances[e]=n,this.injectIntoInstance(n,!1,t);var o=Reflect.getMetadata("component:init",t.fn.prototype);return this.maybeLazyInitialize(n,o,t),n},n.waitForInjectInitializers=function(t){var e=this,n=Reflect.getMetadata("component:injects",t.fn.prototype);if(n&&n.some(function(t){return Reflect.getMetadata("component:init:async",t.type.prototype)}))return Promise.all(n.map(function(t){var n=e.getInjectComponentMetadata(t),o=n[0],r=n[1],i=u(o)?e.getOrCreateFactory(o):e.getOrCreate(o,r);return e.getInitializerPromise(i)}))},n.hasEnteredScope=function(t){return!t.options.scope||Boolean(t.options.scope&&this.scopes[t.options.scope])},n.configureExternal=function(t,e){var n={fn:e,options:{}},o=this.getConstructorParameters({fn:e,options:{}}),i=r(e,t.concat(o));this.injectIntoInstance(i,!0,n);var a=Reflect.getMetadata("component:init",e.prototype);return this.maybeLazyInitialize(i,a,n),i},n.maybeLazyInitialize=function(t,e,n){var o=this,r=this.waitForInjectInitializers(n);e?this.addInitializerPromise(t,r?r.then(function(){return t[e].call(t)||Promise.resolve()}).then(function(){return o.notifyOnReady(t)}):(t[e].call(t)||Promise.resolve()).then(function(){return o.notifyOnReady(t)})):r?(r.then(function(){return o.notifyOnReady(t)}),this.addInitializerPromise(t,r)):this.notifyOnReady(t)},n.injectIntoInstance=function(t,e,n){var o=Reflect.getMetadata("component:injects",n.fn.prototype);if(o)for(var r,a=function(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return i(t,void 0);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,void 0):void 0}}(t))){n&&(t=n);var o=0;return function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}(o);!(r=a()).done;){var c=r.value;D("injecting %s.%s",t.constructor.name,c.property),c.options.name&&void 0!==this.properties[c.options.name]?t[c.property]=this.properties[c.options.name]:this.injectDependency(t,e,c,n)}},n.injectDependency=function(t,e,n,o){if(!this.injectAutoMock(t,n))if(this.isAsyncInitializerDependency(n)||!n.options.lazy&&!n.options.dynamic)this.isAsyncFactoryInjection(n)?this.createAsyncFactoryInjection(t,n):t[n.property]=this.getComponentDependency(n,o,e);else{var r=this;Object.defineProperty(t,n.property,{configurable:!0,enumerable:!0,get:function(){D("lazy-resolve injected property %s.%s",t.constructor.name,n.property);var i=r.getComponentDependency(n,o,e);return n.options.dynamic?i:(Object.defineProperty(t,n.property,{enumerable:!0,value:i}),D("lazy-resolved injected property %s.%s <- %o",t.constructor.name,n.property,t[n.property]),t[n.property])}})}},n.createAsyncFactoryInjection=function(t,e){var n=this.getInjectComponentMetadata(e)[0];if(!u(n))throw new Error("Illegal state: async factory injection without factory metadata");var o=this.getOrCreateFactory(n),r=this.getInitializerPromise(o),i=!1;r&&r.then(function(){i=!0}),Object.defineProperty(t,e.property,{configurable:!0,enumerable:!0,get:function(){if(i){var r=o[n.property]();return Object.defineProperty(t,e.property,{enumerable:!0,value:r}),r}throw new Error("Illegal state: need to wait for factory to resolve")}})},n.isAsyncFactoryInjection=function(t){var e=this.getInjectComponentMetadata(t)[0];return!!u(e)&&this.hasAsyncFactoryInitializer(e)},n.isAsyncInitializerDependency=function(t){var e=this.getInjectComponentMetadata(t)[0],n=u(e)?this.hasAsyncFactoryInitializer(e):Reflect.getMetadata("component:init:async",e.fn.prototype);if(n&&t.options.dynamic)throw new Error("Injecting "+t.type.name+" into "+t.target.constructor.name+"#"+t.property+" must not be dynamic since "+t.type.name+" has an async initializer");return n},n.injectAutoMock=function(t,e){if(!this.autoMock)return!1;var n=this.getInjectComponentMetadata(e)[0];if(n){var o=u(n)?n.rtti:n.fn;if(this.autoMock.indexOf(o)>-1)return!1;var r=this.mock(o);if(r)return t[e.property]=r,!0}return!1},n.createAutoMock=function(t){if(this.autoMock&&!(this.autoMock.indexOf(t)>-1)){var e={__tsdi__mock__:"This is a TSDI automock"},n=t.prototype;return Object.getOwnPropertyNames(n).forEach(function(t){"function"==typeof n[t]&&(e[t]=function(){return[].slice.call(arguments)})}),e||void 0}},n.mock=function(t){console.warn("#mock is deprecated and should not be used. Instead use #override.");var e=this.getComponentMetadataIndex(t);if(!this.instances[e]){var n=this.createAutoMock(t);if(!n)throw new Error("Failed to create mock from "+t.name);this.instances[e]=n}return this.instances[e]},n.getInjectComponentMetadata=function(t){var e=this.getComponentMetadataIndex(t.type,t.options.name);-1===e&&(this.checkAndThrowDependencyError(t),e=this.getComponentMetadataIndex(t.type,t.type.name));var n=this.components[e];if(!n){if(this.parent)return this.parent.getInjectComponentMetadata(t);throw new Error("Failed to get inject '"+(t.type.name||t.options.name)+"' for '"+t.target.constructor.name+"#"+t.property+"'")}return[n,e]},n.getComponentDependency=function(t,e,n){var o=this.getInjectComponentMetadata(t),r=o[0],i=o[1];return n||t.options.dynamic||u(r)||!r.options.scope||e.options.scope||console.warn("Component '"+r.fn.name+"' is scoped to '"+r.options.scope+"' and injected into '"+e.fn.name+"' without scope. This could easily lead to stale references. Consider to add the scope '"+r.options.scope+"' to '"+e.fn.name+"' as well or make the inject dynamic."),this.getOrCreate(r,i)},n.checkAndThrowDependencyError=function(t){if(t.type&&t.options.name){var e=new Error("Injecting undefined type on "+t.target.constructor.name+"#"+t.property+": Component named '"+t.options.name+"' not found");throw D(e),D("Known Components: %o",this.components.map(function(t){return u(t)?t.rtti.name:t.fn.name})),e}if(!t.type||t.options.name){var n=new Error("Injecting undefined type on "+t.target.constructor.name+"#"+t.property+": Probably a cyclic dependency, switch to name based injection");throw D(n),n}},n.get=function(t,e){var n;"string"==typeof t?(e=t,n=void 0):n=t;var o=this.getComponentMetadataIndex(n,e),r=this.components[o];if(!r){if(this.parent)return this.parent.get(t);this.throwComponentNotFoundError(n,e)}return this.getOrCreate(r,o)},n.asyncGet=function(t){try{var e=this;return Promise.resolve(new Promise(function(n){var o=e.addLifecycleListener({onReady:function(e){e instanceof t&&(o(),n(e))}});e.get(t)}))}catch(t){return Promise.reject(t)}},n.override=function(t,e){var n=this.getComponentMetadataIndex(t);this.instances[n]=e,D("Override %o with %o",t,e)},n.getScope=function(t){var e=this;return{enter:function(){e.scopes[t]=!0},leave:function(){delete e.scopes[t],e.components.filter(function(e){return!u(e)&&e.options.scope===t}).forEach(function(t){var n=e.getComponentMetadataIndex(u(t)?t.rtti:t.fn);e.destroyInstance(n,t)})}}},t}();t.Component=v,t.Configure=S,t.Destroy=b,t.External=w,t.Factory=R,t.Initialize=z,t.Inject=F,t.TSDI=L,t.component=I,t.configure=S,t.destroy=M,t.external=_,t.factory=E,t.initialize=P,t.inject=A});
//# sourceMappingURL=index.umd.js.map
